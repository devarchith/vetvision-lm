name: CI — Smoke Tests

on:
  push:
    branches: ["main", "master", "dev"]
  pull_request:
    branches: ["main", "master"]
  workflow_dispatch:

jobs:
  smoke-test:
    name: Smoke Tests (CPU, no real data)
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install torch==2.1.0 torchvision==0.16.0 --index-url https://download.pytorch.org/whl/cpu
          pip install -r requirements.txt --extra-index-url https://download.pytorch.org/whl/cpu
          pip install -e .
        env:
          PIP_NO_CACHE_DIR: "0"

      - name: Set PYTHONPATH
        run: echo "PYTHONPATH=$GITHUB_WORKSPACE/src" >> $GITHUB_ENV

      - name: Run unit tests (pytest)
        run: |
          pytest tests/ -v --tb=short -x \
            --ignore=tests/__init__.py \
            -k "not TestVisionEncoder and not TestVetVisionLM"
        # Note: Vision encoder tests require timm model downloads — skipped in CI
        # Full model tests also skip to avoid large model downloads in free CI runners

      - name: Smoke test — pretrain pipeline
        run: python scripts/pretrain.py --smoke-test

      - name: Smoke test — finetune pipeline
        run: python scripts/finetune.py --smoke-test

      - name: Smoke test — evaluation pipeline
        run: python scripts/evaluate.py --smoke-test

      - name: Smoke test — manifest generator
        run: python scripts/generate_manifest.py --smoke-test --output /tmp/smoke_manifest.csv

      - name: Smoke test — demo (no server launch)
        run: python scripts/demo.py --smoke-test

      - name: Verify author metadata
        run: |
          echo "=== Git log (last 3 commits) ==="
          git log --oneline -3 --format="%H %an <%ae>" || echo "No commits yet"
